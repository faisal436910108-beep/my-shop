<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>منصة محاكاة اختبارات محاسبية | الرئيسية</title>
<style>
  :root{ --bg:#f9fafb; --card:#fff; --muted:#6b7280; --text:#1f2937; --brand:#3b82f6; --border:rgba(0,0,0,.12);}
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif}
  .container{max-width:1100px; margin:16px auto; padding:0 16px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px}
  .btn{background:var(--brand); color:#fff; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700}
  .hidden{display:none!important}
  .square{max-width:560px; margin:auto; background:#fff; border:1px solid var(--border); border-radius:16px; padding:18px; display:grid; gap:14px}
  .qbox{background:#f3f4f6; border:1px solid var(--border); border-radius:12px; padding:14px; font-size:18px}
  .choice{border:1px solid var(--border); border-radius:12px; padding:12px; cursor:pointer; text-align:start}
  .choice.selected{background:#dbeafe; border-color:var(--brand)}
  .final{text-align:center; font-weight:800; padding:10px; border-radius:12px; background:#f9fafb}
  .review{margin-top:14px; padding:12px; border-radius:12px; background:#f9fafb; border:1px solid var(--border)}
  .pass{color:#16a34a} .fail{color:#dc2626}
  .timer{position:fixed; top:14px; inset-inline-end:14px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 12px; font-weight:800; min-width:140px; text-align:center}
</style>
</head>
<body>
<div class="container">

  <!-- تسجيل الدخول -->
  <section id="page-login" class="page">
    <div class="card">
      <h2>تسجيل الدخول</h2>
      <input id="emailInput" type="email" placeholder="name@example.com" style="width:100%;padding:12px;margin-bottom:10px;border:1px solid var(--border);border-radius:10px">
      <button id="loginBtn" class="btn">تسجيل الدخول</button>
      <p id="loginError" class="fail hidden">فضلاً أدخل بريد صحيح</p>
    </div>
  </section>

  <!-- البداية -->
  <section id="page-start" class="page hidden">
    <div class="card">
      <h2>ابدأ الاختبار</h2>
      <button id="goToQuiz" class="btn">ابدأ الآن</button>
    </div>
  </section>

  <!-- الاختبار -->
  <section id="page-quiz" class="page hidden">
    <div id="timer" class="timer hidden">01:20:00</div>
    <div class="square">
      <div class="qbox" id="qText">—</div>
      <div class="choices" id="choices"></div>
      <div class="final hidden" id="finalBox"></div>
      <div class="review hidden" id="reviewBox"></div>
      <button class="btn" id="nextBtn" disabled>التالي</button>
    </div>
  </section>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* إعداد Supabase */
const SUPABASE_URL  = "https://ryafsydlamazuofjdxvm.supabase.co"; // ضع رابطك
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // ضع مفتاحك
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* عناصر */
const pageLogin=document.getElementById('page-login');
const pageStart=document.getElementById('page-start');
const pageQuiz=document.getElementById('page-quiz');
const emailInput=document.getElementById('emailInput');
const loginBtn=document.getElementById('loginBtn');
const loginError=document.getElementById('loginError');
const goToQuiz=document.getElementById('goToQuiz');
const qText=document.getElementById('qText');
const choicesBox=document.getElementById('choices');
const nextBtn=document.getElementById('nextBtn');
const finalBox=document.getElementById('finalBox');
const reviewBox=document.getElementById('reviewBox');
const timerEl=document.getElementById('timer');

/* أسئلة تجريبية */
const QUESTIONS=[{text:"[نظري] أي الجمل أدق عن القسط الثابت؟",choices:["يستهلك قيمة الأصل بالكامل","قسط سنوي = (التكلفة - المتبقي) ÷ العمر","لا يتأثر بالتغيير","لا يستخدم للأصول الإنتاجية"],correctIndex:1}];

let idx=0, userAnswers=[], score=0, userEmail=null;
let remaining=0, intervalId=null;

/* تسجيل الدخول */
loginBtn.addEventListener('click',()=>{
  const email=(emailInput.value||'').trim();
  const ok=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  if(!ok){loginError.classList.remove('hidden');return;}
  loginError.classList.add('hidden');
  userEmail=email;
  localStorage.setItem('userEmail',email);
  pageLogin.classList.add('hidden');
  pageStart.classList.remove('hidden');
});

/* بدء الاختبار */
goToQuiz.addEventListener('click',()=>{
  pageStart.classList.add('hidden');
  pageQuiz.classList.remove('hidden');
  idx=0;score=0;userAnswers=[];
  startTimer();
  loadQuestion();
});

/* المؤقت */
function fmt(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;const pad=n=>String(n).padStart(2,'0');return `${pad(h)}:${pad(m)}:${pad(ss)}`;}
function updateTimerUI(){timerEl.textContent=fmt(remaining);}
function tick(){remaining--; if(remaining<=0){remaining=0; stopTimer(); endQuiz("انتهى الوقت ⏰");} updateTimerUI();}
function startTimer(){remaining=80*60; updateTimerUI(); timerEl.classList.remove('hidden'); stopTimer(); intervalId=setInterval(tick,1000);}
function stopTimer(){if(intervalId){clearInterval(intervalId);intervalId=null;}}

/* تحميل سؤال */
function loadQuestion(){
  const q=QUESTIONS[idx];
  qText.textContent=q.text;
  choicesBox.innerHTML='';
  q.choices.forEach((c,i)=>{
    const btn=document.createElement('button');
    btn.className='choice';
    btn.textContent=c;
    if(userAnswers[idx]===i) btn.classList.add('selected');
    btn.onclick=()=>{document.querySelectorAll('.choice').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');userAnswers[idx]=i;nextBtn.disabled=false;};
    choicesBox.appendChild(btn);
  });
  nextBtn.disabled=(userAnswers[idx]==null);
}

/* التالي */
nextBtn.addEventListener('click',()=>{
  if(userAnswers[idx]==null)return;
  idx++;
  if(idx<QUESTIONS.length){loadQuestion();}
  else endQuiz("انتهيت من جميع الأسئلة 🎉");
});

/* إنهاء */
async function endQuiz(message){
  stopTimer();
  score=userAnswers.reduce((a,ans,i)=>a+(ans===QUESTIONS[i].correctIndex?1:0),0);
  const total=QUESTIONS.length;
  const pct=Math.round((score/total)*100);
  const passed=pct>=60;
  finalBox.classList.remove('hidden');
  finalBox.innerHTML=`<div>${message||''}</div><div>نتيجتك: <strong>${score}</strong> من <strong>${total}</strong> (${pct}%)</div><div class="${passed?'pass':'fail'}">${passed?'ناجح 🎉':'راسب 😢'}</div>`;
  reviewBox.classList.remove('hidden');
  reviewBox.innerHTML=QUESTIONS.map((q,i)=>`<div><b>س${i+1}:</b> ${q.text}<br>إجابتك: ${q.choices[userAnswers[i]]||'—'}<br>الصحيحة: ${q.choices[q.correctIndex]}</div>`).join('<hr>');
  
  if(userEmail){
    const { error } = await supa.from('results_open').insert({
      email:userEmail,
      score:score,
      total:total,
      percent:pct,
      details:JSON.stringify(userAnswers)
    });
    if(error) console.error('DB error',error.message);
  }
}
</script>
</body>
</html>
