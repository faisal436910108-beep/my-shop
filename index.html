<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù…Ù†ØµØ© Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø­Ø§Ø³Ø¨ÙŠØ© | Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
<meta name="description" content="Ù…Ù†ØµØ© Ø¹Ø±Ø¨ÙŠØ© Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø©: Ø£Ø³Ø¦Ù„Ø© Ù†Ø¸Ø±ÙŠØ© ÙˆÙ…Ø³Ø§Ø¦Ù„ Ø¹Ù…Ù„ÙŠØ©ØŒ Ù…Ø¤Ù‚ØªØŒ Ù†ØªØ§Ø¦Ø¬ Ù…ÙØµÙ„Ø©. Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø¢Ù†.">
<link rel="canonical" href="https://example.com/">
<meta name="robots" content="index, follow">
<meta property="og:title" content="Ù…Ù†ØµØ© Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø­Ø§Ø³Ø¨ÙŠØ©">
<meta property="og:description" content="Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø­Ø§Ø³Ø¨ÙŠØ© ÙˆØ²ÙƒØ§Ø©/Ø¶Ø±ÙŠØ¨Ø© Ø¨Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§Ù‚Ø¹ÙŠØ© ÙˆÙ†ØªØ§Ø¦Ø¬ ÙÙˆØ±ÙŠØ©.">
<meta property="og:url" content="https://example.com/">
<meta property="og:type" content="website">
<meta property="og:image" content="https://example.com/cover.jpg">
<link rel="icon" href="/favicon.ico">
<style>
  :root{ --bg:#f9fafb; --card:#fff; --muted:#6b7280; --text:#1f2937; --brand:#3b82f6; --border:rgba(0,0,0,.12);}
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif}
  a{color:inherit; text-decoration:none}

  /* Header */
  header{position:sticky; top:0; z-index:60; backdrop-filter: blur(10px); background: color-mix(in srgb, var(--bg) 95%, transparent); border-bottom:1px solid var(--border)}
  .topbar{max-width:1100px; margin:auto; padding:10px 16px; display:flex; align-items:center; gap:12px}
  .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,var(--brand),#60a5fa)}
  .brand{font-weight:800}
  .spacer{flex:1}
  .nav a, .nav button{padding:8px 10px; border-radius:10px; border:1px solid transparent; background:transparent; cursor:pointer; font:inherit; color:inherit}
  .nav a.active, .nav a:hover, .nav button:hover{border-color:var(--border); background:rgba(0,0,0,.04)}
  .login-top-btn{background:#fff; border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer}
  .userchip{display:flex; align-items:center; gap:8px; background:#eef2ff; color:#1e293b; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:14px}
  .logout{cursor:pointer; color:#ef4444; font-weight:700}

  /* Layout */
  .container{max-width:1100px; margin:16px auto; padding:0 16px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .grid{display:grid; gap:12px; grid-template-columns:1fr 1fr}
  @media(max-width:800px){.grid{grid-template-columns:1fr}}
  .muted{color:var(--muted)}
  .btn{background:#f3f4f6; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 14px; cursor:pointer}
  .btn.primary{background:linear-gradient(135deg,var(--brand),#60a5fa); color:#fff; font-weight:800; border-color:transparent}
  .hidden{display:none !important}

  /* HUD */
  .timer{position:fixed; top:14px; inset-inline-end:14px; z-index:55; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 12px; font-weight:800; min-width:140px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .infochips{position:fixed; bottom:14px; inset-inline-start:14px; z-index:55; display:flex; gap:8px; flex-wrap:wrap; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 12px; font-weight:700; box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .chip{background:#f3f4f6; border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:14px}

  /* Quiz Box */
  .square{width:min(92vw, 560px); margin:auto; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; display:grid; grid-template-rows:auto auto auto auto auto; gap:14px; position:relative; z-index:80; box-shadow:0 4px 12px rgba(0,0,0,.1)}
  .title{font-weight:800; font-size:18px}
  .progress{font-size:14px; color:var(--muted)}
  .qbox{background:#f3f4f6; border:1px solid var(--border); border-radius:12px; padding:14px; line-height:1.75; font-size:18px}
  .answers{margin-top:10px}
  .choices{display:grid; gap:12px}
  .choice{appearance:none; border:1px solid rgba(0,0,0,.12); background:#fff; color:inherit; padding:12px 14px; border-radius:12px; text-align:start; cursor:pointer; transition:all .2s ease}
  .choice:hover{transform:translateY(-1px); border-color:var(--brand); background:#eff6ff}
  .choice.selected{outline:2px solid var(--brand); background:#dbeafe}
  .final{text-align:center; font-weight:800; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#f9fafb}
  .review{margin-top:14px; padding:12px; border-radius:12px; background:#f9fafb; border:1px solid var(--border); font-size:14px; line-height:1.6}
  .correctAns{color:#16a34a} .wrongAns{color:#dc2626}
  .row{display:flex; gap:8px; justify-content:center}
  .pass{color:#16a34a} .fail{color:#dc2626}

  /* Right nav numbers */
  .qpanel{position:fixed; top:86px; inset-inline-end:14px; z-index:40; width:240px; max-height:60vh; overflow:auto; background:#fff; border:1px solid var(--border); border-radius:14px; padding:10px; box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .qpanel h4{margin:0 0 8px; font-size:14px; color:var(--muted)}
  .qnav{display:grid; grid-template-columns:repeat(5,1fr); gap:6px}
  .qnum{padding:8px 0; border:1px solid var(--border); background:#f3f4f6; color:var(--text); border-radius:10px; cursor:pointer; text-align:center; font-weight:700}
  .qnum.active{outline:2px solid var(--brand); background:#dbeafe}
  .qnum.answered{border-color:var(--brand)}

  /* Login */
  .login-wrap{display:grid; place-items:center; min-height:60vh}
  .login-form{display:grid; gap:12px; max-width:420px; width:100%}
  .input{width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; font-size:16px}
  .hint{font-size:13px; color:var(--muted)}
  .error-msg{color:#dc2626; font-weight:700; font-size:14px}
  .toast{position:fixed; top:80px; inset-inline-start:50%; transform:translateX(-50%); background:#fff; color:#111827; border:1px solid var(--border); padding:10px 14px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.08); z-index:70}

  /* History (Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ÙŠ) */
  .table{width:100%; border-collapse:collapse; font-size:14px}
  .table th, .table td{border-bottom:1px solid var(--border); padding:10px; text-align:start}
  .table th{background:#f3f4f6; color:#111827; position:sticky; top:0}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; border:1px solid var(--border)}
  .pill.pass{color:#16a34a; border-color:#16a34a33; background:#16a34a0f}
  .pill.fail{color:#dc2626; border-color:#dc262633; background:#dc26260f}
  .hist-cards{display:none}
  @media (max-width:720px){
    .hist-table{display:none}
    .hist-cards{display:grid; gap:10px}
    .hist-card{border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff}
    .hist-row{display:flex; justify-content:space-between; gap:12px; margin:6px 0}
    .hist-label{color:#6b7280}
  }
</style>

<!-- Supabase SDK + Ø§Ù„ØªÙ‡ÙŠØ¦Ø© (Ø¨Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ…) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL  = "https://YOUR-PROJECT.supabase.co";       // <-- ØºÙŠÙ‘Ø±Ù‡Ø§
  const SUPABASE_ANON = "YOUR_PUBLIC_ANON_KEY";                    // <-- ØºÙŠÙ‘Ø±Ù‡Ø§
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
</script>

<!-- Structured Data -->
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebSite","name":"Ù…Ù†ØµØ© Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø­Ø§Ø³Ø¨ÙŠØ©","url":"https://example.com/","inLanguage":"ar","potentialAction":{"@type":"SearchAction","target":"https://example.com/?q={search_term_string}","query-input":"required name=search_term_string"}}
</script>
</head>
<body>
<header>
  <div class="topbar">
    <div class="logo" aria-hidden="true"></div>
    <div class="brand">Ù…Ù†ØµØ© Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
    <div class="spacer"></div>

    <!-- Login chip/button -->
    <button id="loginTopBtn" class="login-top-btn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <div id="userChip" class="userchip hidden">
      <span id="userEmailText">â€”</span>
      <span class="logout" id="logoutBtn" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">Ø®Ø±ÙˆØ¬</span>
    </div>

    <nav class="nav">
      <a href="/index.html" class="active">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="/bank.html">Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</a>
      <a href="/about.html">Ø¹Ù† Ø§Ù„Ù…Ù†ØµÙ‘Ø©</a>
      <a href="/results.html">Ø¥Ø±Ø´Ø§Ø¯Ø§Øª</a>
      <button id="historyTopBtn" title="Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ÙŠ">Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ÙŠ</button>
    </nav>
  </div>
</header>

<div class="container">
  <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <section id="page-login" class="page hidden">
    <div class="login-wrap">
      <div class="card login-form">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¨Ø¯Ø¡</h2>

        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
          <input id="emailInput" type="email" class="input" placeholder="name@example.com" autocomplete="email" required>
        </label>

        <div class="hint">Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ ÙˆØ³Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø±Ø§Ø¨Ø· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ù„Ø§ ØªØ­ØªØ§Ø¬ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±.</div>
        <div id="loginError" class="error-msg hidden">ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§.</div>

        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button id="sendLinkBtn" class="btn primary" type="button">Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
  <section id="page-start" class="page">
    <div class="grid">
      <div class="card">
        <h1 style="margin:0 0 6px">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h1>
        <p class="muted">Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ù‘ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙˆÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</p>
        <button class="btn primary" id="goToQuiz">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
      </div>
      <div class="card">
        <h3>Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØµÙ‘Ø©ØŸ</h3>
        <p class="muted">Ø£Ø³Ø¦Ù„Ø© Ù†Ø¸Ø±ÙŠØ© ÙˆÙ…Ø³Ø§Ø¦Ù„ Ø¹Ù…Ù„ÙŠØ© Ø¨Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø©ØŒ Ù…Ø¤Ù‚ØªØŒ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¬Ø§Ø¨Ø§ØªØŒ ÙˆÙˆØ§Ø¬Ù‡Ø© RTL Ø¹Ø±Ø¨ÙŠØ©.</p>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
  <section id="page-quiz" class="page hidden">
    <div class="timer hidden" id="timer">05:00</div>
    <div class="infochips hidden" id="infochips">
      <span class="chip" id="progress">Ø³Ø¤Ø§Ù„ 1 / 1</span>
      <span class="chip">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score">0</span></span>
    </div>

    <aside class="qpanel hidden" id="qpanel">
      <h4>Ø£Ø³Ø¦Ù„Ø©</h4>
      <div class="qnav" id="qnav"></div>
    </aside>

    <div class="square">
      <div class="title">Ù„ÙˆØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
      <div class="progress" id="pSmall">â€”</div>
      <div class="qbox" id="qText">â€”</div>
      <div class="answers"><div class="choices" id="choices"></div></div>
      <div class="final hidden" id="finalBox"></div>
      <div class="review hidden" id="reviewBox"></div>
      <div class="row">
        <button class="btn" id="nextBtn" type="button" disabled>Ø§Ù„ØªØ§Ù„ÙŠ â­ï¸</button>
        <button class="btn hidden" id="restartBtn" type="button">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø¯Ø¡ â†»</button>
      </div>
    </div>
  </section>

  <!-- Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ÙŠ -->
  <section id="page-history" class="page hidden">
    <div class="card">
      <h2 style="margin:0 0 10px">Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ÙŠ</h2>
      <p class="muted" id="histHint">ÙŠØ¹Ø±Ø¶ Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</p>

      <!-- Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© -->
      <div class="hist-table">
        <table class="table" id="historyTable">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
              <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr>
          </thead>
          <tbody id="historyTbody">
            <tr><td colspan="4" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯â€¦</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© -->
      <div class="hist-cards" id="historyCards"></div>
    </div>
  </section>
</div>

<div id="toast" class="toast hidden">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>

<script>
/* ====== ØµÙØ­Ø§Øª ====== */
const pages = {
  login : document.getElementById('page-login'),
  start : document.getElementById('page-start'),
  quiz  : document.getElementById('page-quiz'),
  history: document.getElementById('page-history'),
};
function show(name){
  Object.values(pages).forEach(p=>p.classList.add('hidden'));
  pages[name].classList.remove('hidden');
  if(name!=='quiz') hideHUD?.();
}

/* ====== Ø¹Ù†Ø§ØµØ± Ø¯Ø®ÙˆÙ„ ====== */
const loginTopBtn    = document.getElementById('loginTopBtn');
const userChip       = document.getElementById('userChip');
const userEmailText  = document.getElementById('userEmailText');
const logoutBtn      = document.getElementById('logoutBtn');
const emailInput     = document.getElementById('emailInput');
const sendLinkBtn    = document.getElementById('sendLinkBtn');
const loginError     = document.getElementById('loginError');
const toast          = document.getElementById('toast');
const historyTopBtn  = document.getElementById('historyTopBtn');

function showToast(msg){ toast.textContent=msg; toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'), 2200); }
function isValidEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }

/* ====== Magic Link ====== */
async function loginWithEmail(email){
  const { error } = await supa.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: window.location.origin }
  });
  if (error) throw error;
}

/* ====== ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù„Ø³Ø© ====== */
async function refreshAuthUI(){
  const { data: { user } } = await supa.auth.getUser();
  if (user){
    userChip.classList.remove('hidden');
    loginTopBtn.classList.add('hidden');
    userEmailText.textContent = user.email || 'â€”';
    // ØªØ£ÙƒØ¯ ÙˆØ¬ÙˆØ¯ Ø¨Ø±ÙˆÙØ§ÙŠÙ„
    await supa.from('profiles').upsert({ id: user.id, full_name: null });
  } else {
    userChip.classList.add('hidden');
    loginTopBtn.classList.remove('hidden');
  }
}

/* Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø© */
supa.auth.onAuthStateChange(async (_evt, _session)=>{ await refreshAuthUI(); });

/* Ø£Ø²Ø±Ø§Ø± */
loginTopBtn?.addEventListener('click', ()=> show('login'));
sendLinkBtn?.addEventListener('click', async ()=>{
  const email = (emailInput.value||'').trim();
  if(!isValidEmail(email)){ loginError.classList.remove('hidden'); emailInput.focus(); return; }
  loginError.classList.add('hidden');
  try{
    await loginWithEmail(email);
    showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ');
  }catch(e){
    loginError.classList.remove('hidden');
    loginError.textContent = 'Ø®Ø·Ø£: '+e.message;
  }
});
logoutBtn?.addEventListener('click', async ()=>{
  await supa.auth.signOut();
  stopTimer?.();
  hideHUD?.();
  show('login');
  showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
});
historyTopBtn?.addEventListener('click', async ()=>{
  const ok = await requireAuthOrRedirect();
  if(!ok) return;
  show('history');
  loadMyResults();
});

/* ====== Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨Ø¯Ø¡ ====== */
async function requireAuthOrRedirect(){
  const { data: { user } } = await supa.auth.getUser();
  if(!user){ show('login'); showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); return false; }
  return true;
}

/* ====== Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ====== */
const goToQuiz=document.getElementById('goToQuiz');
const timerEl=document.getElementById('timer');
const infochips=document.getElementById('infochips');
const progressEl=document.getElementById('progress');
const scoreEl=document.getElementById('score');
const pSmall=document.getElementById('pSmall');
const qText=document.getElementById('qText');
const choicesBox=document.getElementById('choices');
const finalBox=document.getElementById('finalBox');
const reviewBox=document.getElementById('reviewBox');
const nextBtn=document.getElementById('nextBtn');
const restartBtn=document.getElementById('restartBtn');
const qpanel=document.getElementById('qpanel');
const qnav=document.getElementById('qnav');

function showHUD(){ timerEl.classList.remove('hidden'); infochips.classList.remove('hidden'); qpanel.classList.remove('hidden'); }
function hideHUD(){ timerEl.classList.add('hidden'); infochips.classList.add('hidden'); qpanel.classList.add('hidden'); }

/* Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯ Ù„Ù„ØªØ¬Ø±Ø¨Ø© */
const INITIAL_SECONDS=5*60;
const QUESTIONS=[{ text:"[Ù†Ø¸Ø±ÙŠ] Ø£ÙŠ Ø§Ù„Ø¬Ù…Ù„ Ø£Ø¯Ù‚ Ø¹Ù† Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ø¨ØªØŸ", choices:["ÙŠØ³ØªÙ‡Ù„Ùƒ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ","Ù‚Ø³Ø· Ø³Ù†ÙˆÙŠ = (Ø§Ù„ØªÙƒÙ„ÙØ© - Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ) Ã· Ø§Ù„Ø¹Ù…Ø±","Ù„Ø§ ÙŠØªØ£Ø«Ø± Ø¨Ø£ÙŠ ØªØºÙŠÙŠØ± ØªÙ‚Ø¯ÙŠØ±","Ù„Ø§ ÙŠØ¬ÙˆØ² Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"], correctIndex:1 }];

let remaining=INITIAL_SECONDS, intervalId=null, idx=0, finished=false, userAnswers=[], score=0;

function fmt(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;const pad=n=>String(n).padStart(2,'0');return `${pad(h)}:${pad(m)}:${pad(ss)}`}
function updateTimerUI(){ timerEl.textContent=fmt(remaining); }
function tick(){ remaining--; if(remaining<=0){ remaining=0; stopTimer(); return endQuiz("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª â°"); } updateTimerUI(); }
function startTimer(){ stopTimer(); intervalId=setInterval(tick,1000); }
function stopTimer(){ if(intervalId){ clearInterval(intervalId); intervalId=null; } }

function beginWrapper(){
  show('quiz'); showHUD();
  finalBox.classList.add('hidden'); reviewBox.classList.add('hidden');
  remaining=INITIAL_SECONDS; updateTimerUI(); startTimer();
  idx=0; finished=false; userAnswers=new Array(QUESTIONS.length).fill(null); score=0; scoreEl.textContent=score;
  renderQNav(); loadQuestion();
}

async function begin(){
  const ok = await requireAuthOrRedirect();
  if(!ok) return;
  beginWrapper();
}

function restart(){ stopTimer(); beginWrapper(); restartBtn.classList.add('hidden'); nextBtn.disabled=(userAnswers[idx]==null); }

function renderQNav(disable=false){
  qnav.innerHTML='';
  QUESTIONS.forEach((_,i)=>{ const b=document.createElement('button'); b.type='button'; b.className='qnum'; b.textContent=(i+1);
    if(i===idx) b.classList.add('active'); if(userAnswers[i]!==null) b.classList.add('answered'); b.disabled=disable;
    b.addEventListener('click',()=>{ if(finished) return; idx=i; loadQuestion(); renderQNav(); });
    qnav.appendChild(b);
  });
}
function loadQuestion(){
  if(idx>=QUESTIONS.length) return endQuiz("Ø§Ù†ØªÙ‡ÙŠØª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ğŸ‰");
  const q=QUESTIONS[idx];
  qText.textContent=q.text;
  progressEl.textContent=`Ø³Ø¤Ø§Ù„ ${idx+1} / ${QUESTIONS.length}`;
  pSmall.textContent=`${idx+1} Ù…Ù† ${QUESTIONS.length}`;
  choicesBox.innerHTML='';
  q.choices.forEach((label,i)=>{ const btn=document.createElement('button'); btn.type='button'; btn.className='choice'; btn.textContent=label;
    if(userAnswers[idx]===i) btn.classList.add('selected');
    btn.addEventListener('click',()=>{ document.querySelectorAll('.choice').forEach(c=>c.classList.remove('selected')); btn.classList.add('selected'); userAnswers[idx]=i; nextBtn.disabled=false; renderQNav(); });
    choicesBox.appendChild(btn);
  });
  nextBtn.disabled=(userAnswers[idx]==null);
}
function nextQuestion(){ if(finished) return; if(userAnswers[idx]==null) return; idx++; if(idx<QUESTIONS.length){ loadQuestion(); renderQNav(); } else endQuiz("Ø§Ù†ØªÙ‡ÙŠØª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ğŸ‰"); }

/* Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Supabase (Ø¢Ù…Ù† ØªØ­Øª RLS) */
async function saveResultToDB({ score, total, reviewDetails }){
  const { data: { user } } = await supa.auth.getUser();
  if(!user) return;
  const { error } = await supa.from('results').insert({
    user_id: user.id,
    score,
    total,
    details: reviewDetails
  });
  if (error) console.error('DB insert error:', error.message);
}

function endQuiz(message){
  finished=true; stopTimer();
  score = userAnswers.reduce((acc,ans,i)=> acc + ((ans===QUESTIONS[i].correctIndex)?1:0), 0);
  scoreEl.textContent=score;
  const total=QUESTIONS.length, pct=Math.round((score/total)*100), passed=pct>=60;
  finalBox.classList.remove('hidden');
  finalBox.innerHTML=`<div>${message}</div><div style="margin-top:6px">Ù†ØªÙŠØ¬ØªÙƒ: <strong>${score}</strong> Ù…Ù† <strong>${total}</strong> â€” (<strong>${pct}%</strong>)</div><div class="${passed?'pass':'fail'}" style="margin-top:8px;font-size:18px;font-weight:800">${passed?'Ù†Ø§Ø¬Ø­ ğŸ‰':'Ø±Ø§Ø³Ø¨ â€¢ Ø£Ø±Ø¬Ø¹ Ø°Ø§ÙƒØ±'}</div>`;
  const rows=QUESTIONS.map((q,i)=>{ const your=userAnswers[i]!=null?q.choices[userAnswers[i]]:'â€”'; const ok=q.choices[q.correctIndex]; const okCls=(userAnswers[i]===q.correctIndex)?'correctAns':'wrongAns'; return `<div><strong>Ø³${i+1}:</strong> ${q.text}<br>Ø¥Ø¬Ø§Ø¨ØªÙƒ: <span class="${okCls}">${your}</span><br>Ø§Ù„ØµØ­ÙŠØ­Ø©: <span class="correctAns">${ok}</span></div>`; }).join('<hr>');
  reviewBox.classList.remove('hidden'); reviewBox.innerHTML='<h3>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª:</h3>'+rows;
  renderQNav(true); nextBtn.disabled=true; restartBtn.classList.remove('hidden'); restartBtn.onclick=restart;

  // Ø§Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„
  try{
    const payload = QUESTIONS.map((q,i)=>({
      q: q.text,
      your: userAnswers[i] != null ? q.choices[userAnswers[i]] : null,
      correct: q.choices[q.correctIndex],
      isCorrect: userAnswers[i] === q.correctIndex
    }));
    saveResultToDB({ score, total: QUESTIONS.length, reviewDetails: payload });
  }catch(e){ console.warn(e); }
}

/* ====== Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ÙŠ ====== */
async function loadMyResults(){
  const tbody  = document.getElementById('historyTbody');
  const cards  = document.getElementById('historyCards');
  tbody.innerHTML = `<tr><td colspan="4" class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>`;
  cards.innerHTML = '';

  const { data: { user } } = await supa.auth.getUser();
  if(!user){
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</td></tr>`;
    return;
  }

  const { data, error } = await supa
    .from('results')
    .select('score,total,percent,created_at')
    .order('created_at', { ascending: false })
    .limit(20);

  if (error){
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø¨.</td></tr>`;
    console.error(error.message);
    return;
  }

  if (!data || data.length===0){
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¨Ø¹Ø¯â€¦</td></tr>`;
    return;
  }

  // Ø¬Ø¯ÙˆÙ„
  tbody.innerHTML = '';
  data.forEach(row=>{
    const pct = Math.round(Number(row.percent ?? (row.total? (row.score/row.total*100) : 0)));
    const pass = pct >= 60;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(row.created_at).toLocaleString('ar-SA')}</td>
      <td><strong>${row.score}</strong> / ${row.total}</td>
      <td>${pct}%</td>
      <td><span class="pill ${pass?'pass':'fail'}">${pass?'Ù†Ø§Ø¬Ø­':'Ø±Ø§Ø³Ø¨'}</span></td>
    `;
    tbody.appendChild(tr);
  });

  // Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„
  data.forEach(row=>{
    const pct = Math.round(Number(row.percent ?? (row.total? (row.score/row.total*100) : 0)));
    const pass = pct >= 60;
    const div = document.createElement('div');
    div.className = 'hist-card';
    div.innerHTML = `
      <div class="hist-row"><span class="hist-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</span><span>${new Date(row.created_at).toLocaleString('ar-SA')}</span></div>
      <div class="hist-row"><span class="hist-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©</span><span><strong>${row.score}</strong> / ${row.total}</span></div>
      <div class="hist-row"><span class="hist-label">Ø§Ù„Ù†Ø³Ø¨Ø©</span><span>${pct}%</span></div>
      <div class="hist-row"><span class="hist-label">Ø§Ù„Ø­Ø§Ù„Ø©</span><span class="pill ${pass?'pass':'fail'}">${pass?'Ù†Ø§Ø¬Ø­':'Ø±Ø§Ø³Ø¨'}</span></div>
    `;
    cards.appendChild(div);
  });
}

document.getElementById('goToQuiz').addEventListener('click', begin);
nextBtn.addEventListener('click', nextQuestion);

/* init */
(async ()=>{
  await refreshAuthUI();
  show('start');
})();
</script>
</body>
</html>
